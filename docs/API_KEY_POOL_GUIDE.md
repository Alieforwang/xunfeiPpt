# APIå¯†é’¥æ± é…ç½®æŒ‡å—

ä¸ºäº†æé«˜APIè°ƒç”¨çš„å¹¶å‘èƒ½åŠ›å’Œç¨³å®šæ€§ï¼Œæœ¬é¡¹ç›®æ”¯æŒé…ç½®å¤šä¸ªè®¯é£æ™ºæ–‡APIå¯†é’¥å½¢æˆå¯†é’¥æ± ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### ğŸ”„ æ™ºèƒ½è½®æ¢
- **æœ€ä¼˜é€‰æ‹©**ï¼šæ ¹æ®é”™è¯¯ç‡å’Œå¹¶å‘è´Ÿè½½è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¯†é’¥
- **è´Ÿè½½å‡è¡¡**ï¼šé¿å…å•ä¸ªå¯†é’¥è¿‡è½½
- **æ•…éšœè½¬ç§»**ï¼šå¯†é’¥è¾¾åˆ°é™åˆ¶æ—¶è‡ªåŠ¨åˆ‡æ¢

### ğŸ“Š å¹¶å‘æ§åˆ¶
- **ç‹¬ç«‹é™åˆ¶**ï¼šæ¯ä¸ªå¯†é’¥å¯è®¾ç½®ä¸åŒçš„å¹¶å‘é™åˆ¶
- **å®æ—¶ç›‘æ§**ï¼šè·Ÿè¸ªæ¯ä¸ªå¯†é’¥çš„ä½¿ç”¨æƒ…å†µ
- **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®å®é™…æƒ…å†µä¼˜åŒ–åˆ†é…

### ğŸ›¡ï¸ å®¹é”™æœºåˆ¶
- **è‡ªåŠ¨é‡è¯•**ï¼šå¤±è´¥æ—¶è‡ªåŠ¨å°è¯•å…¶ä»–å¯†é’¥
- **é”™è¯¯ç»Ÿè®¡**ï¼šè®°å½•æ¯ä¸ªå¯†é’¥çš„æˆåŠŸç‡
- **æ™ºèƒ½é™çº§**ï¼šä¼˜å…ˆä½¿ç”¨æˆåŠŸç‡é«˜çš„å¯†é’¥

## âš™ï¸ é…ç½®æ–¹æ³•

### 1. åŸºç¡€é…ç½®

åœ¨ `main.py` ä¸­æ‰¾åˆ° `API_KEY_POOL` é…ç½®ï¼š

```python
API_KEY_POOL = [
    {
        "app_id": "2dc9dc12",
        "api_secret": "YWVmZjQ0NTI4MjkxMTEzMTA5MWZiY2M4",
        "name": "ä¸»å¯†é’¥",
        "max_concurrent": 10,  # æœ€å¤§å¹¶å‘æ•°
        "enabled": True
    },
    # æ·»åŠ æ›´å¤šå¯†é’¥
    {
        "app_id": "your_app_id_2",
        "api_secret": "your_api_secret_2", 
        "name": "å¤‡ç”¨å¯†é’¥1",
        "max_concurrent": 5,
        "enabled": True
    },
    {
        "app_id": "your_app_id_3",
        "api_secret": "your_api_secret_3",
        "name": "å¤‡ç”¨å¯†é’¥2", 
        "max_concurrent": 8,
        "enabled": True
    }
]
```

### 2. å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `app_id` | string | âœ… | è®¯é£æ™ºæ–‡åº”ç”¨ID |
| `api_secret` | string | âœ… | è®¯é£æ™ºæ–‡APIå¯†é’¥ |
| `name` | string | â­ | å¯†é’¥åç§°ï¼Œä¾¿äºç®¡ç†å’Œè°ƒè¯• |
| `max_concurrent` | int | â­ | æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ï¼Œé»˜è®¤10 |
| `enabled` | bool | â­ | æ˜¯å¦å¯ç”¨æ­¤å¯†é’¥ï¼Œé»˜è®¤true |

### 3. é«˜çº§é…ç½®ç¤ºä¾‹

```python
# é’ˆå¯¹ä¸åŒåœºæ™¯çš„å¯†é’¥é…ç½®
API_KEY_POOL = [
    {
        "app_id": "main_key",
        "api_secret": "main_secret",
        "name": "é«˜æ€§èƒ½ä¸»å¯†é’¥", 
        "max_concurrent": 20,  # é«˜å¹¶å‘
        "enabled": True
    },
    {
        "app_id": "backup_key1", 
        "api_secret": "backup_secret1",
        "name": "æ ‡å‡†å¤‡ä»½å¯†é’¥",
        "max_concurrent": 10,  # ä¸­ç­‰å¹¶å‘
        "enabled": True
    },
    {
        "app_id": "test_key",
        "api_secret": "test_secret", 
        "name": "æµ‹è¯•ä¸“ç”¨å¯†é’¥",
        "max_concurrent": 3,   # ä½å¹¶å‘ï¼Œæµ‹è¯•ç”¨
        "enabled": False       # ç”Ÿäº§ç¯å¢ƒç¦ç”¨
    }
]
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. ä½¿ç”¨MCPå·¥å…·ç›‘æ§

```bash
# é€šè¿‡MCPè°ƒç”¨æŸ¥çœ‹å¯†é’¥æ± çŠ¶æ€
curl -X POST http://localhost:8002/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "get_api_pool_stats",
      "arguments": {}
    }
  }'
```

### 2. çŠ¶æ€ä¿¡æ¯è¯´æ˜

è¿”å›çš„ç»Ÿè®¡ä¿¡æ¯åŒ…å«ï¼š

```json
{
  "total_keys": 3,           // æ€»å¯†é’¥æ•°
  "active_keys": 2,          // æ´»è·ƒå¯†é’¥æ•°
  "usage_stats": {
    "0": {
      "requests": 25,        // æ€»è¯·æ±‚æ•°
      "errors": 1,           // é”™è¯¯æ¬¡æ•°
      "concurrent": 3        // å½“å‰å¹¶å‘æ•°
    }
  },
  "key_info": [
    {
      "name": "ä¸»å¯†é’¥",
      "concurrent": 3,       // å½“å‰å¹¶å‘
      "max_concurrent": 10   // æœ€å¤§å¹¶å‘
    }
  ]
}
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œå¯†é’¥æ± åŠŸèƒ½æµ‹è¯•
cd tests
python test_api_pool.py
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¹¶å‘é…ç½®

- **ä¸»å¯†é’¥**ï¼šè®¾ç½®è¾ƒé«˜çš„ `max_concurrent`ï¼ˆ15-20ï¼‰
- **å¤‡ç”¨å¯†é’¥**ï¼šè®¾ç½®ä¸­ç­‰çš„ `max_concurrent`ï¼ˆ5-10ï¼‰
- **æµ‹è¯•å¯†é’¥**ï¼šè®¾ç½®è¾ƒä½çš„ `max_concurrent`ï¼ˆ1-3ï¼‰

### 2. å¯†é’¥åˆ†å±‚

```python
# æ¨èçš„åˆ†å±‚é…ç½®
API_KEY_POOL = [
    # ç¬¬ä¸€å±‚ï¼šé«˜æ€§èƒ½å¯†é’¥
    {"app_id": "premium1", "max_concurrent": 20, "name": "é«˜çº§å¯†é’¥1"},
    {"app_id": "premium2", "max_concurrent": 20, "name": "é«˜çº§å¯†é’¥2"},
    
    # ç¬¬äºŒå±‚ï¼šæ ‡å‡†å¯†é’¥
    {"app_id": "standard1", "max_concurrent": 10, "name": "æ ‡å‡†å¯†é’¥1"},
    {"app_id": "standard2", "max_concurrent": 10, "name": "æ ‡å‡†å¯†é’¥2"},
    
    # ç¬¬ä¸‰å±‚ï¼šå¤‡ç”¨å¯†é’¥
    {"app_id": "backup1", "max_concurrent": 5, "name": "å¤‡ç”¨å¯†é’¥1"},
]
```

### 3. ç›‘æ§æŒ‡æ ‡

å…³æ³¨ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š
- **é”™è¯¯ç‡**ï¼šåº”ä¿æŒåœ¨5%ä»¥ä¸‹
- **å¹¶å‘åˆ©ç”¨ç‡**ï¼šé¿å…é•¿æœŸè¾¾åˆ°100%
- **å“åº”æ—¶é—´**ï¼šç›‘æ§APIå“åº”å»¶è¿Ÿ

## ğŸ”§ æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

**å¯†é’¥æ— æ•ˆ**
```
é”™è¯¯: ç­¾åéªŒè¯å¤±è´¥
è§£å†³: æ£€æŸ¥app_idå’Œapi_secretæ˜¯å¦æ­£ç¡®
```

**å¹¶å‘è¶…é™**
```
é”™è¯¯: æ‰€æœ‰å¯†é’¥éƒ½è¾¾åˆ°å¹¶å‘é™åˆ¶
è§£å†³: å¢åŠ max_concurrentæˆ–æ·»åŠ æ›´å¤šå¯†é’¥
```

**ç½‘ç»œé”™è¯¯**
```
é”™è¯¯: è¿æ¥è¶…æ—¶
è§£å†³: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œè€ƒè™‘å¢åŠ é‡è¯•æ¬¡æ•°
```

### 2. è°ƒè¯•æŠ€å·§

**å¯ç”¨è¯¦ç»†æ—¥å¿—**
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

**å•ç‹¬æµ‹è¯•å¯†é’¥**
```python
# ä¸´æ—¶ä½¿ç”¨å•ä¸ªå¯†é’¥æµ‹è¯•
test_pool = [{"app_id": "test_id", "api_secret": "test_secret", "enabled": True}]
client = AIPPTClient(key_pool=test_pool)
```

**ç›‘æ§å¹¶å‘æƒ…å†µ**
```python
# å®šæœŸæ£€æŸ¥çŠ¶æ€
stats = client.get_pool_stats()
for key in stats['key_info']:
    print(f"{key['name']}: {key['concurrent']}/{key['max_concurrent']}")
```

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. å¯†é’¥ç®¡ç†
- âœ… ä½¿ç”¨æè¿°æ€§çš„å¯†é’¥åç§°
- âœ… å®šæœŸæ£€æŸ¥å¯†é’¥æœ‰æ•ˆæ€§
- âœ… ä¸ºä¸åŒç¯å¢ƒé…ç½®ä¸åŒå¯†é’¥æ± 
- âŒ ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æµ‹è¯•å¯†é’¥

### 2. å¹¶å‘è®¾ç½®
- âœ… æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®å¹¶å‘é™åˆ¶
- âœ… ä¸ºé«˜ä¼˜å…ˆçº§ä»»åŠ¡é¢„ç•™å®¹é‡
- âœ… ç›‘æ§å¹¶å‘ä½¿ç”¨æƒ…å†µ
- âŒ ä¸è¦è®¾ç½®è¿‡é«˜çš„å¹¶å‘å¯¼è‡´APIé™åˆ¶

### 3. å®¹é”™è®¾è®¡
- âœ… é…ç½®å¤šä¸ªå¤‡ç”¨å¯†é’¥
- âœ… è®¾ç½®é€‚å½“çš„é‡è¯•æ¬¡æ•°
- âœ… ç›‘æ§é”™è¯¯ç‡å’ŒæˆåŠŸç‡
- âŒ ä¸è¦ä¾èµ–å•ä¸ªå¯†é’¥

## ğŸ”„ ä»å•å¯†é’¥è¿ç§»

### 1. æ¸è¿›å¼è¿ç§»

```python
# ç¬¬ä¸€æ­¥ï¼šä¿æŒåŸæœ‰é…ç½®
API_KEY_POOL = [
    {
        "app_id": "original_id",
        "api_secret": "original_secret", 
        "name": "åŸå§‹å¯†é’¥",
        "max_concurrent": 10,
        "enabled": True
    }
]

# ç¬¬äºŒæ­¥ï¼šæ·»åŠ å¤‡ç”¨å¯†é’¥
API_KEY_POOL.append({
    "app_id": "backup_id",
    "api_secret": "backup_secret",
    "name": "å¤‡ç”¨å¯†é’¥",
    "max_concurrent": 5,
    "enabled": True
})

# ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–é…ç½®
# æ ¹æ®ç›‘æ§æ•°æ®è°ƒæ•´å¹¶å‘é™åˆ¶
```

### 2. å…¼å®¹æ€§ä¿è¯

- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- APIè°ƒç”¨æ¥å£ä¿æŒä¸å˜
- å‘åå®Œå…¨å…¼å®¹
- å¯éšæ—¶å›é€€åˆ°å•å¯†é’¥æ¨¡å¼

é€šè¿‡åˆç†çš„å¯†é’¥æ± é…ç½®ï¼Œå¯ä»¥æ˜¾è‘—æé«˜PPTç”ŸæˆæœåŠ¡çš„å¹¶å‘èƒ½åŠ›å’Œç¨³å®šæ€§ï¼